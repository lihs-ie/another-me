# UI エラーハンドリング設計

## エラー種別と対応

| エラー種別                     | 例                                                                 | UI 表現                           | 再試行方法                                      |
|--------------------------------|--------------------------------------------------------------------|-----------------------------------|-------------------------------------------------|
| ネットワーク切断/タイムアウト   | Firebase Storage からのダウンロード失敗                             | SnackBar + Download モーダルへ遷移 | 「再試行」ボタン → `CatalogDownloadController.retry()` |
| チェックサム不一致              | ダウンロードした音源と catalog.json のチェックサムが一致しない         | Music モーダルのリスト項目に警告アイコン | 再ダウンロードを促す（詳細メッセージを表示）              |
| SQLite 書き込みエラー          | SessionLog append 時に DB ロック                                   | Dialog（致命的エラー）              | OK で閉じた後、自動リトライまたはサポートへ連絡            |
| ライセンスファイル取得失敗       | LicenseRecord.registerFromCatalog でファイルDL失敗                  | Download モーダルで警告             | 再試行ボタンで job を再キュー                          |
| 用户操作エラー（入力範囲外）     | PomodoroPolicy で 0 分など不正値を入力                             | インライン警告（フォーム下）         | 正しい範囲を説明するツールチップ                         |
| 通知許可拒否                    | OS で通知が無効                                                    | SnackBar + Notification モーダル案内 | モーダルで OS 設定へ誘導                                |

## UI コンポーネントの使い分け

- **SnackBar**：軽微なエラー、短時間で消える通知（ネットワーク再試行など）。
- **Dialog**：ユーザー操作が必要な致命的エラー（DB 書き込み失敗など）。
- **インライン警告**：フォーム入力時のバリデーションエラー。
- **バッジ**：DownloadProgressBadge にエラー件数を表示し、詳細モーダルへ誘導。

## ログ・トラッキング

- アプリ内は `Logger`（クロスカッティングにて定義）を使用し、エラー種別・スタックトレースを記録。
- Firebase Crashlytics や Sentry などを接続する場合、ここでイベントを送信する（将来拡張）。

## 再試行ポリシー

- ネットワークエラー：指数バックオフ（3 回まで）。ユーザーが手動再試行する場合は retry_count をリセット。
- DB エラー：アプリの整合性を保つため即座に中断 → ユーザーへ再起動案内。
- ダウンロードエラー：ジョブを Failed 状態にし、Download モーダルから再試行可能にする。

## テスト観点

- オフラインモードでのダウンロード操作 → SnackBar と再試行ボタンが機能するか。
- フォームのバリデーション（境界値テスト） → インライン警告の文言とアクセシビリティを確認。
- DB エラーをモックし、Dialog が表示されるか確認。
