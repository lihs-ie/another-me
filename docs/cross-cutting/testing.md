# テスト戦略（高位方針）

## レイヤー別テスト

| レイヤー                | テスト種別                   | 目的                                             |
|-------------------------|------------------------------|--------------------------------------------------|
| ドメイン（集約/VO）       | ユニットテスト               | 不変条件・ドメインロジックの検証                 |
| ユースケース（docs/use-cases） | 統合テスト（モックリポジトリ） | トランザクション境界・イベント発火の順序確認       |
| インフラ（リポジトリ/ACL）   | 統合テスト                   | SQLite/Firebase Storage の実書きテスト（モック含む） |
| プレゼンテーション         | ウィジェットテスト / ゴールデン | UI レイアウト、アクセシビリティ、国際化の確認       |
| E2E                     | Integration Test + Driver   | 主要ユーザーシナリオの自動テスト                 |

## CI 実行順序（推奨）

1. lint / format チェック
2. ドメイン＆ユースケースのユニットテスト
3. インフラ統合テスト（SQLite をインメモリで）
4. ウィジェットテスト / ゴールデンテスト
5. main ブランチでのみ E2E テスト（Firebase Storage はモック）

## モック戦略

- Riverpod Provider を `ProviderScope.override` で差し替え。
- Firebase Storage は `FirebaseStorageClient` のモック実装を注入。
- SQLite は `sqflite_common_ffi` のインメモリ機能を利用。

## ゴールデンテスト詳細

- `golden_toolkit` を利用し、主要画面のスクリーンショットを @1x/@2x の整数スケールで比較。
- `FilterQuality.none`（nearest-neighbor）が適用されているか確認し、ピクセルアートのぼやけを防止。
- テストケース例：
  - ブレークポイントごとのレイアウト（デスクトップ/タブレット/モバイル）。
  - キャラクター衣装切替（朝/昼/夜）。
  - ダウンロード進捗バッジの各状態（進行中/失敗）。
