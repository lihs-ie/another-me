# ユースケース UC05: 集中モード（バックグラウンド配慮）を有効化する

## 目的
- ユーザーがアプリをバックグラウンドで利用する際、リソース消費を抑えつつ音楽とアニメーションを継続させる。

## アクター
- メインアクター：ユーザー
- サポートアクター：アプリ（描画・オーディオエンジン、UsageMetrics）

## 事前条件
- アプリが起動しており、音楽再生またはポモドーロセッションが進行中。
- システム設定でバックグラウンド再生が許可されている。

## トリガー
- ユーザーがアプリウィンドウを最小化する、または他アプリへフォーカスを移す。

## 基本フロー
1. アプリがフォーカス喪失イベントを受け取り、キャラクターアニメーションを 30fps → 15fps、背景を 24fps → 12fps にダウンサンプリングする。
2. 音楽再生は継続しつつ、フェードや音量調整は通常どおり処理される。
3. ポモドーロセッションが進行している場合、フェーズ遷移や通知はバックグラウンドでも発火する。
4. UsageMetrics が CPU/メモリ使用量を記録し、閾値を超えた場合はアニメーションをさらに抑制する提案を行う。
5. ユーザーがアプリに戻ると、FPS が通常値に復帰し、視覚的なズレがないか確認される。

## 代替フロー
- **サイレントモード**: ユーザーが通知をミュートにしている場合、デスクトップ通知は suppress され、メニューバー残り時間のみ更新される。
- **自動夜間モード**: 夜間帯に入ると背景の明度が下がり、キャラクター衣装も `DayPeriodChanged` に基づいて切り替わる。

## 例外フロー
- **オーディオデバイス切断**: 外部デバイスが切断された場合、デフォルト出力へフェールオーバーし、ユーザーへ通知する。
- **CPU 制限超過**: 連続的に CPU 使用率が 12% を超えた場合、アニメーションを静止画（最小フレーム）に切り替え、UsageMetrics から警告を表示する。

## 事後条件
- バックグラウンド利用中もポモドーロ記録と再生が継続する。
- 復帰後は通常のアニメーションと通知動作に戻る。
# ユースケース UC05: 集中モード（バックグラウンド配慮）を有効化する

## 外部設計

### 目的
- アプリがバックグラウンドに回った際、CPU/GPU 使用を抑制しつつ音楽再生とポモドーロセッションを継続させ、ユーザーの集中体験を維持する。

### アクター
- メインアクター：ユーザー
- サポートアクター：アプリ（Media・Avatar・Scene・Work・Telemetry 境界）

### 事前条件
- アプリが起動し、BGM 再生またはポモドーロセッションが進行中。
- macOS のバックグラウンド再生が許可されており、通知権限が授与されている。

### トリガー
- ウィンドウの最小化、他アプリへのフォーカス移動、またはユーザーが「集中モード」を明示的にオンにする。

### 基本フロー
1. フォーカス喪失イベントを検知すると、集中モードユースケースが `AvatarSceneController.enterBackgroundMode()` を呼び出し、キャラクター/背景の描画 FPS を所定の値（例：30→15、24→12）に低減する。描画停止までは行わず、必要な最小フレームを保持する。
2. Media 境界の `PlaybackController` は再生を継続し、フェード・音量操作は通常通り処理する。音量メータなどの高頻度 UI 更新は抑制する。
3. Work 境界の `PomodoroSession` は `tick` を継続し、フェーズ完了時には `PomodoroPhaseCompleted` / `PomodoroSessionCompleted` を発火する。通知境界はバックグラウンド許可設定に従ってデスクトップ通知またはメニューバー更新を行う。
4. Telemetry 境界の `UsageMetricsCollector` が CPU・メモリ使用率を継続計測し、閾値（例：CPU 12%）を超えた場合、追加の抑制案内（アニメーション停止など）を UI へ提示する。
5. ユーザーがアプリへ復帰すると `AvatarSceneController.exitBackgroundMode()` が呼ばれ、FPS が通常値に戻る。復帰時にアニメーション状態が破綻していないか確認し、必要に応じ `SceneLayout` を再計算する。

### 代替フロー
- **通知サイレント**：ユーザーが通知をミュートしている場合、デスクトップ通知は抑制し、メニューバー残り時間とバッジ表示のみ更新する。
- **夜間モード連動**：夜間帯に突入すると `DayPeriodChanged` をトリガーに、明度を下げた背景・衣装へ切り替えたまま集中モードを継続する。
- **ポモドーロなし**：セッションが稼働していない場合、Work 境界との連携は発生せず、描画・再生の節電制御のみ行う。

### 例外フロー
- **オーディオデバイス切断**：バックグラウンド中に出力デバイスが切断された場合、`PlaybackController` がデフォルトデバイスへフェールオーバーし、ユーザーに通知する。失敗した場合は BGM を一時停止する。
- **CPU 制限超過**：UsageMetrics が一定期間 CPU 使用率閾値を超過したと判定した場合、キャラクターを静止フレームに固定し、背景更新を停止する。ユーザーに「描画を抑制しました」と通知する。
- **権限不足**：通知権限が取り消された場合、メニューバー通知のみで代替し、設定画面に再許可を促す。

### 事後条件
- バックグラウンド滞在中もポモドーロ記録・BGM 再生が継続し、リソース消費が抑えられる。
- 復帰後、描画・通知・メトリクス収集が通常モードに戻る。

## 内部設計

### 関連ドメインモデル

#### UsageMetricsCollector（telemetry）
- 概要：CPU・メモリ使用量を計測し、閾値超過時に `PerformanceAlertRaised` を発火するサービス。
- ユースケース利用箇所：集中モード移行中のリソース監視、追加抑制の判断。

#### AvatarSceneController（avatar/scene アプリケーション層）
- 概要：キャラクターと背景の描画設定を統合制御するアプリケーションサービス。
- 主な振る舞い：
  - `enterBackgroundMode()`：FPS の低減、アニメーションループの簡略化。
  - `exitBackgroundMode()`：通常 FPS への復帰、レイアウト再計算。

#### PlaybackController（media）
- 概要：BGM 再生、フェード、デバイス切替を制御するアプリケーションサービス。
- 集中モードでは高頻度 UI 更新を抑制しつつ再生を継続する。

#### PomodoroSession（work）
- 概要：ポモドーロタイマーの状態管理。バックグラウンドでも `tick` が呼ばれ、フェーズ完了イベントを発火する。

#### NotificationFacade（notification）
- 概要：通知の許可状況を確認し、バックグラウンド時はサイレント／通常通知を切り替える。

### データフロー
1. OS からフォーカス喪失イベントが届き、アプリケーション層が集中モードユースケースを起動。
2. Avatar/Scene・Media のコントローラが描画 FPS と再生 UI 更新頻度を調整。
3. Telemetry 境界がリソース使用量を継続監視し、閾値超過時に `PerformanceAlertRaised` を通知。
4. Work 境界がバックグラウンドでも `PomodoroSession.tick` を継続し、フェーズイベントを通知境界へ送出。
5. フォーカス復帰イベントで集中モードを解除し、すべての境界が通常設定に戻る。
