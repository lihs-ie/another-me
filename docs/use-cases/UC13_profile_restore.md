# ユースケース UC13: 前回状態の保存と復元

## 目的
- ユーザーがアプリを再起動した際に、前回のキャラクター・背景・音量・ポモドーロ設定などが復元され、即座に作業を再開できる。

## アクター
- メインアクター：システム（アプリ起動・終了処理）
- サポートアクター：UserProfile 集約、Storage レイヤ

## 事前条件
- `UserProfile` が少なくとも一度保存されている。
- 永続化ストレージ（SQLite/JSON）が正常に読み書きできる状態。

## トリガー
- アプリ起動時、`restoreOnLaunch` 設定が true の場合。
- アプリ終了時（ウィンドウを閉じる・システム終了）の保存処理。

## 基本フロー
1. 終了時：アプリが現在の `UserProfile` を取得し、選択中キャラクター（selectedCharacterIdentifier）、背景（selectedSceneIdentifier）、音量設定（playbackSettings.volume）、ポモドーロポリシー（pomodoroPolicy）などを永続化する。
2. 起動時：ストレージから `UserProfile` を読み出し、`restoreOnLaunch` が true の場合は自動的に適用する。
3. キャラクター・背景・音量・通知設定が UI とレンダリング層に反映される。
4. 前回ポモドーロセッションが `Completed` であれば `SessionLog` の最新エントリを参照し、ダッシュボードに実績を表示する。

## 代替フロー
- **手動復元オフ**: `restoreOnLaunch=false` の場合は初期状態で起動し、ユーザーが明示的に「前回設定を読み込む」を選択できるようにする。
- **複数プロファイル**: 複数ユーザープロファイルが存在する場合、起動時に選択ダイアログを表示してから復元する。

## 例外フロー
- **データ破損**: 保存ファイルが破損している場合、デフォルト設定で起動し、「設定ファイルを復元できませんでした」と通知する。
- **欠落アセット**: 保存されていたキャラクターや背景が利用不可になっている場合、利用可能なデフォルトに置き換え、ユーザーに案内を表示する。

## 事後条件
- ユーザーは再起動後すぐに作業を再開できる。
- 保存処理・復元処理のログが記録され、トラブルシューティングに利用できる。
# ユースケース UC13: 前回状態の保存と復元

## 外部設計

### 目的
- アプリ再起動時に前回のキャラクター・背景・音量・ポモドーロ設定などを復元し、ユーザーが即座に作業を再開できるようにする。

### アクター
- メインアクター：システム（アプリ起動・終了処理）
- サポートアクター：UserProfile 集約、ストレージ層

### 事前条件
- `UserProfile` が少なくとも一度保存されている。
- 永続化ストレージ（SQLite/JSON）が正常に読み書き可能。

### トリガー
- アプリ終了時（ウィンドウを閉じる・システム終了）に保存処理を実行。
- アプリ起動時、`restoreOnLaunch` 設定が `true` の場合に自動復元を実行。

### 基本フロー
1. **終了時保存**：アプリが現在の `UserProfile` を取得し、選択中キャラクター・背景・音量設定・ポモドーロポリシー・通知設定などを `UserProfileRepository.persist` を通じて永続化する。
2. **起動時復元**：アプリ起動時に `UserProfileRepository.loadDefault()` を呼び出し、`restoreOnLaunch == true` なら自動適用する。`restoreOnLaunch == false` の場合は初期状態で起動し、「前回設定を読み込む」ボタンを提供する。
3. `UserProfile` の値を各境界（Avatar／Scene／Media／Notification／Work）へ適用し、UI・レンダリングに反映する。
4. 前回ポモドーロセッションが `Completed` であれば `SessionLogRepository.findLatest(profile)` を参照し、ダッシュボードへ実績を表示する。

### 代替フロー
- **複数プロファイル**：複数の `UserProfile` をサポートする場合、起動時にプロファイル選択ダイアログを表示し、選択結果を復元する。
- **手動復元**：`restoreOnLaunch == false` のユーザーは、設定画面の「前回設定を読み込む」操作で復元を実行する。

### 例外フロー
- **データ破損**：保存ファイルが破損している場合、デフォルト設定で起動し、「設定ファイルを復元できませんでした」と通知する。破損ファイルはバックアップとして退避する。
- **欠落アセット**：保存されていたキャラクター／背景が利用不可の場合、利用可能なデフォルトへ切り替え、ユーザーへ案内を表示する。

### 事後条件
- ユーザーが再起動後すぐに前回の環境で作業を再開できる。
- 保存・復元処理のログが残り、トラブルシューティングに利用できる。

## 内部設計

### 関連ドメインモデル

#### UserProfile（profile）
- 概要：外観・再生・通知・ポモドーロ設定を保持する集約。
- 主な振る舞い：
  - `takeSnapshot()`：永続化用スナップショットを生成。
  - `restore(snapshot)`：保存済みスナップショットから状態を復元。

#### UserProfileRepository（profile）
- 概要：`UserProfile` の保存・読み込みを担当。
- コールパス：アプリ終了時に `persist`、起動時に `loadDefault`。

#### SessionLogRepository（work）
- 概要：最新のポモドーロ実績を取得し、ダッシュボード表示へ渡す。

#### RecoveryService（アプリケーション層）
- 概要：破損ファイル検知とバックアップ／復旧処理を行う。

### データフロー
1. 終了時に `UserProfile.takeSnapshot()` → `UserProfileRepository.persist(snapshot)` を実行。
2. 起動時に `UserProfileRepository.loadDefault()` → `UserProfile.restore(snapshot)` → 各境界へ設定を適用。
3. `SessionLogRepository.findLatest(profile)` で前回実績を取得し、ダッシュボードへ表示。
4. 復元失敗時は RecoveryService がデフォルト設定を適用し、ユーザーに再設定を促す。
